version: "3.7"
services:
    filtron:
        deploy:
            labels:
                - "caddy.address=searx.be www.searx.be"
                - caddy.targetport=4004
                - caddy.proxy.transparent
                - 'caddy.log_0=/ /var/log/searx.log "{combined} - {latency}"'
                - 'caddy.log_1=/ /var/log/searx_fail2ban.log "{when_unix} {remote} {status}"'
                - "caddy.errors=/var/log/searx_errors.log"
                - "caddy.status=403 /deny"
                - caddy.proxy.header_downstream=-server
                - 'caddy.proxy.header_downstream_0=Content-Security-Policy "default-src ''none''; font-src ''self'' data:; script-src ''self''; img-src * data:; object-src ''none''; style-src ''self'' ''unsafe-inline''; frame-src ''self''; connect-src *; form-action ''self''; base-uri ''self'';frame-ancestors ''self'';"'
                - 'caddy.proxy.header_downstream_1=X-Content-Type-Options nosniff'
                - 'caddy.proxy.header_downstream_2=X-Frame-Options DENY'
                - 'caddy.proxy.header_downstream_3=X-XSS-Protection "1; mode=block"'
                - 'caddy.proxy.header_downstream_4=referrer-policy "strict-origin-when-cross-origin"'
                - 'caddy.proxy.header_downstream_5=strict-transport-security "max-age=63072000; includeSubDomains; preload"'
                - caddy.rewrite_0=/
                - 'caddy.rewrite_0.if_0={query} has "format=json"'
                - 'caddy.rewrite_0.if_1={query} has "format=csv"'
                - 'caddy.rewrite_0.if_2={query} has "format=rss"'
                - caddy.rewrite_0.if_op=or
                - caddy.rewrite_0.to=/deny
                - caddy.gzip
                - caddy.expires
                - "caddy.expires.match=static/* 1w"
                - caddy.errors.403=/root/.caddy/errorspage/HTTP403.html
                - com.ouroboros.enable=true
            placement:
                constraints:
                    - node.hostname == mx.emiliendevos.be
            restart_policy:
                condition: any
        image: dalf/filtron
        command: -listen 0.0.0.0:4004 -target searx:8080
        networks:
            - default
            - proxy_global
        volumes:
            - "/data/searx/filtron/rules.json:/etc/filtron/rules.json:rw"
            - "/etc/localtime:/etc/localtime:ro"
    searx:
        deploy:
            placement:
                constraints:
                    - node.hostname == mx.emiliendevos.be
            labels:
                - com.ouroboros.enable=true
            restart_policy:
                condition: any
        environment:
            - "BASE_URL=https://searx.be"
            - PGID=0
            - PUID=0
        image: searx/searx:latest
        networks:
            - default
            - proxygoogle
        volumes:
            - "/data/searx/settings.yml:/etc/searx/settings.yml:ro"
            - "/etc/localtime:/etc/localtime:ro"
            - "/data/searx/poolrequests.py:/usr/local/searx/searx/poolrequests.py:ro"
            #- "/data/searx/engines/google.py:/usr/local/searx/searx/engines/google.py:ro"
            #- "/data/searx/engines/google.py:/usr/local/searx/searx/engines/google.py:ro"
    proxygoogle:
        deploy:
            placement:
                constraints:
                    - node.hostname == awslinuxdocker
            labels:
                - com.ouroboros.enable=true
            restart_policy:
                condition: any
        secrets:
            - AWS_ACCESS_KEY_ID
            - AWS_SECRET_ACCESS_KEY
        environment:
            - AWS_REGIONS=eu-central-1
            - PROXY_LISTENERS=:8080
            - PROXY_FREQUENCY_REFRESH=5m
        ports:
            - mode: host
              protocol: tcp
              published: 2222
              target: 2222
        image: unixfox/awslambdaproxy
        networks:
            - proxygoogle

secrets:
    AWS_ACCESS_KEY_ID:
        external: true
    AWS_SECRET_ACCESS_KEY:
        external: true

networks:
    default:
    proxygoogle:
    proxy_global:
        external: true
    global:
        external: true
    bridge:
        external: true
